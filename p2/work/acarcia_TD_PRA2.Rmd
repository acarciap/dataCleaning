---
title: "Integración, Limpieza, Validación y Análisis de Datos."
subtitle: "Tipología y Ciclo de Vida de los Datos: Práctica #2"
author: "Antonio Carcia"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: yes
  word_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Sumario
    
  **Fuente**: www.kaggle.com        
  **Insumo**: *Consumo Gasolina Autos Ene 2018.xlsx*     
  **Total Obs.**: *4.617 tuplas*      
    
  **Convenciones, formatos y nomenclatura**:
  
  La variable _**wd**_ debe inicializarse con la ruta en la que se ubica el Fichero de Insumo.
  
  Para propósitos de la estructura de directorios con la que suministra el ejercicio, se utiliza
  la ruta $HOME/dat/in. 
  
  El archivo con datos ajustados (procesados, listo para el análisis) se exporta a la ruta $HOME/dat/clean. 

```{r Carga de libreria, echo=FALSE, message=F, warning=F}
library("openxlsx")
library(VIM)
library(vioplot)    # forma de la distribución junto con la descripció estadistica
library(rpart)

library(caret)      # confusionMatrix()
library(car)

library(tidyverse)
library(ggplot2)
library(corrplot)   # grafica de correlacion de multiples variables
library("clustMixType")
```

# 1. Introducción 

Durante el siguiente trabajo se aborda un caso práctico en el contexto de la asignatura Tipología y Ciclo de Vida de Datos, dirigido a aplicar métodos y técnicas para la preparación de los datos, previamente a su uso en el desarrollo de proyectos analíticos.

Así mismo, se aplican criterios de análisis y selección de atributos, para efectos de  la confección del set de datos final a ser utilizado en la construcción de modelos,  durante el proceso de desarrollo.

## Objetivos:

* Aplicar los conocimientos adquiridos para la resolución de problemas en entornos nuevos o poco conocidos.

* Identificar los datos relevantes y tratamientos necesarios (integración, limpieza y validación) para llevar a cabo un proyecto analítico.

* Aprender a analizar los datos adecuadamente para abordar la información contenida en ellos.

* Identificar la mejor representación de los resultados para aportar conclusiones sobre el problema planteado en el proceso analítico.

* Actuar con los principios éticos y legales relacionados con la manipulación de datos en función del ámbito de aplicación.


# 2. Descripción del Dataset.
El juego de datos seleccionado para el trabajo está relacionado con el registro de características técnicas y prestaciones de marcas de vehículos con modelos hasta el 2.018, y su calificación en relación a la _**Emisión de Gases de Efecto Invernadero**_ y potencial de _**Contaminación del Aire**_. Este es de carácter público, y ha sido obtenido de la siguiente fuente:

  **URL**: https://www.kaggle.com/checoalejandro/autos-consumo-gasolina-mexico#Consumo Gasolina Autos Ene 2018.xlsx

En general, la información relacionada con el set se presenta en forma resumida como sigue:

  **Aspecto** |  **Descripción**
  ------------- | ------------------------------------------------------------------------------ 
  _**Marca**_ | Fabricante del vehículo
  _**Submarca**_ | Modelo de comercialización
  _**Version**_ | Versión de fabricación - breve descripción de características
  _**Modelo**_ | Año al que corresponde el modelo
  _**Trans**_ | Modelo de Transmisión específico o Tipo utilizado en la fabricación del vehículo
  _**Comb**_ | Tipo de Carburante o energía utilizada por el Motor del Vehículo
  _**Cilindros**_ | Cantidad de Cilindros que configuran el Motor
  _**Potencia (HP)**_ | Potencia del Motor
  _**Tamaño (L)**_ | Capacidad del Motor
  _**Categoría**_ | Estilo o Clase de coche
  _**R.Ciudad (Km/L)**_ | Recorrido en Ciudad medido en km por litro de combustible
  _**R.Carr (Km/L)**_ | Recorrido en Carretera medido en km por litro de combustible
  _**R.Comb (Km/L)**_ | Recorrido en Km por Litro
  _**R.Ajust (KM/L)**_ | Recorrido Ajustado medido en Km por Litro
  _**CO2 (gr/Km)**_ | Emisiones de dióxido de carbono en gramos por Km recorrido
  _**NOx (gr/1000Km)**_ | Emisiones de óxido nitroso en gramos por unidades de 1000 Km
  _**Calificación Gas Ef. Inv.**_ | Calificación obtenida en medición de Gases de Efecto Invernadero emitidos
  _**Calificación Contam. Aire**_ | Calificación obtenida en relación al grado de Contaminación del Aire durante su desempeño
  
La muestra está formada por 4.617 observaciones, de 18 atributos.

## Propósito:
Aunque el registro de marcas, versiones y modelos en bastante amplio, éste continuará creciendo en el tiempo, y con ello la necesidad de continuar registrando el impacto ambiental de cada uno de los nuevos modelos. 

Se han observado imprecisiones en el juego de datos que afectan su integridad y completitud. Entre ellos, se aprecia una brecha importante en la columna de _**Calificación de Contaminación del Aire**_.

Se propone desarrollar un modelo a partir de la caracterización recogida en este set, que permita calificar vehículos utilizando criterios similares a los implícitos en la muestra, completando en lo posible la brecha identificada en ellos.

Para esto será necesario procesar adecuadamente los datos objetos de estudio, identificar los atributos que más aportan en la descripción de la situación de interés, y que efectivamente pueden contribuir en la confección de un modelo a partir del que se facilite la correcta clasificación de los vehículos actualmente no calificados y nuevos por incorporar.

Si bien, la muestra disponible evidencia una condición de desbalanceo en la clasificación inicial que aportan, se espera lograr la confección de un modelo que resulte suficientemente explicativo y con capacidad predictiva, para contribuir en el objetivo que nos hemos impuesto.

De resultar adecuado el modelo que se obtenga, puede ser utilizado para completar los valores perdidos en relación a la calificación del renglón de _**Contaminación del Aire**_, y soportar la validación de nuevos registros (producto de incorporaciones futuras).

# 3. Integración y Selección de los Datos de Interés.

El set de datos se asume autocontenido, por lo que no es necesario enriquecerlo, ni procesamientos adicionales en este sentido.

Se procede a la importación del archivo de insumo.

```{r Cargando Datos}
##### Cargando datos para exploración  --------------------
wd <- "./../dat/in"

setwd(wd)
cga2018 <- read.xlsx("Consumo Gasolina Autos Ene 2018.xlsx", sheet=1)

##### Total de filas cargadas  -----------------------------
nrow( cga2018 )
```

Una vez ejecutada la carga de datos, y luego de haber validado que la cantidad de observaciones incorporadas a las estructuras dispuestas por el ambiente de trabajo coincide con la documentación del set, se procede con la inspección de los tipos de datos asignados automáticamente a cada atributo durante la operación.

```{r Inspección de estructura y adecuación de tipos}
### Inspección de estructura de datos y verificación de tipos de datos asignados
###
str(cga2018)
```

Se observa que varios de los atributos responden al propósito de identificar la instancia a la que se refieren, exponiendo información de carácter descriptivo.

Tales campos serán convertidos a tipo factor para facilitar el procesamiento, tan pronto haya sido verificada la condición en relación a la ausencia de valores vacios. Particularmente, los campos _**Calificación Gases de Efecto Invernadero**_ y _**Contaminación de Aire**_, será convertidos a tipo entero, hasta que llegue la ocasión de formalizar nuevamente su conversión a tipo factor.

Así mismo, se aprovecha el ajuste para abreviar el nombre de algunos de los atributos del set

```{r Ajustes de tipos de atributos y denominación de columnas de la estructura }
### Ajustes de tipos de atributos y denominación de columnas de la estructura
###
colnames(cga2018) <- c("marca",        # Fabricante del vehículo
                       "submarca",     # Submarca Comercial del vehículo
                       "vr",           # Versión del Modelo
                       "mod",          # Año al que corresponde el Modelo
                       "trans",        # Tipo de Transmisión
                       "comb",         # Tipo de Combustible que emplea
                       "cil",          # Número de Cilindros del motor
                       "pot",          # Potencia del motor
                       "tam",          # Tamaño o Capacidad ( en Ltros) del motor
                       "cat",          # Categoria del Vehículo
                       "r.Ciudad",     # Recorrido en Ciudad (Rendimiento por Litro)
                       "r.Carretera",  # Recorrido en Carretera (Rendimiento por Litro)
                       "r.Comb",       # Recorrido por Con¿mbustible (Rendimiento por Litro)
                       "r.Ajust",      # Recorrido Ajustado (Rendimiento por Litro)
                       "CO2",          # Emisión  de CO2 (g/km)
                       "NOx",          # Emisión  de NOX (g/1000km)
                       "GEI",          # Calificación: Emisión de Gases de Efecto Invernadero
                       "CA")           # Calificación: Contaminación del Aire 

cga2018$GEI <- as.integer( cga2018$GEI )
```

Finalmente, el atributo _**Calificación de Contaminación del Aire**_, también se considera un tipo enumerado, por lo que debe ser convertido a una variable categórica de tipo factor. Antes, una primera conversión a tipo entero, que sustitye los placeholders que indican valores perdidos sobre la variable (caracter '?´) por valores N.A.

```{r Adecuación del Tipo correspondiente al atributo CA}
### Adecuación del Tipo correspondiente al atributo CA
###
cga2018$CA <- as.integer( cga2018$CA ) # Se convierten a NA los valores perdidos
cga2018$CA <-factor( cga2018$CA )
```


# 4. Limpieza de Datos.

## 4.1. Elementos Vacíos, Ceros y Nulos
La validación de Valores tipo carácter con entradas vacías, demuestra que todas las entradas de este tipo se encuentran inicializadas, por lo que no se requiere tomar ninguna acción particular con respecto a este tipo de campos

```{r Verificación de Ausencia de Contenido }
### Verificación de Ausencia de Contenido
###
col.nbr <- colnames(cga2018)

for( i in 1:length(col.nbr) )
  if (is.character( cga2018[i] ))
    if ( sum(is.na(cga2018[i]) ) == 0)
       if ( sum( cga2018[i]== "" ) !=0 )
            print( col.nbr[i] )
```

En consecuencia, puede procederse con la conversión de tipos propuesta

```{r Conversion de Tipo para campos caracter }
### Conversión de Tipo para campos carácter
###
cga2018$mod   <-factor( cga2018$mod )
cga2018$trans <-factor( cga2018$trans )
cga2018$comb  <-factor( cga2018$comb )
cga2018$cat   <-factor( cga2018$cat )

cga2018$cil <- factor( cga2018$cil )
cga2018$cil <- ordered( cga2018$cil, levels=c("3","4","5", "6", "8", "10", "12"))
```

Continuando con la identificación de atributos con valores perdidos, sigue la verificación de presencia de valores N.A.

```{r Verificación de Valores Nulos  }
### Verificación de Valores Nulos
###
for(i in 1:length(col.nbr) )
   if ( sum(is.na(cga2018[i]) ) != 0){
        print( col.nbr[i] )
   }
```

Determinación de la cantidad de registros en situación de valores perdidos para el atributo _**trans**_

```{r Verificación de Valores Nulos - atr trans }
### identificación de registros con Valores Nulos para atributo trans
###
which( is.na(cga2018$trans) )
```

Consulta de contexto sobre registros con valores perdidos para el atributo _**trans**_, con objeto de determinar algún criterio que permita decidir el tratamiento más adecuado para su inicialización:

```{r Verificación de Valores Nulos - atr trans - determinación de criterios tratamiento}
### Consulta de registros con Valores Nulos para atributo trans
###
atr2show <- c("marca", "submarca", "vr", "mod")
cga2018[ which( is.na(cga2018$trans) ), atr2show ]
```

Todos los vehículos a los que les falta valor para el campo _**trans**_ son de _**marca**_ **Honda** y _**modelo**_ 2017, y de acuerdo al campo _**vr**_ puede identificarse en otros registros similares que el valor faltante corresponde al tipo de caja **CVT**. Por lo tanto, el ajuste debe ser realizado asignando directamente dicho valor al atributo para aquellas observaciones que no exhiban valor (Esto es, se trata de una inconsistencia en los datos que puede ser corregida manualmente).

```{r Verificación de Valores Nulos - atr trans - correccion }
### Ajuste de registros con Valores Nulos para atributo trans
###
cga2018$trans <- as.character(cga2018$trans) 
cga2018[ which( is.na(cga2018$trans) ), "trans" ] <- "CVT"
cga2018$trans <-factor( cga2018$trans )
```

La corrección de la lista de niveles incluidos en el factor _**trans**_, requiere convertir el atributo a tipo carácter, realizar el ajuste, y finalmente reconvertir el atributo a tipo factor.

Siguiendo con el atributo destinado a la calificación por _**Contaminación de Aire**_ ( _**CA**_), tenemos que:
```{r Verificación de Valores Nulos - atr CA }
### Cuantificación de registros con Valores Nulos para atributo Calificación Contaminación Aire
###
length( which( is.na(cga2018$CA) )) 
```

Este atributo exhibe una gran cantidad de valores perdidos (un poco más del 25% de las observaciones). Los elementos faltantes pueden intentar ser completados una vez construido el modelo, si las condiciones lo permiten. 

No obstante, de las observaciones completas se dispone de valores para el atributo _**CA**_, que serán tomados para efectos de confeccionar una partición que pueda ser empleada como set de Entrenamiento y otra como set de Test.

Identificación de atributos con valores inicializados a cero, que pudieran ser objetos de revisión.

```{r Verificación de atributos inicializados a Cero }
### Verificación de atributos incorrectamente inicializaciones a Cero
###
for( i in 1:length(col.nbr) )
    if ( sum(is.na(cga2018[i]) ) == 0)
      if ( length(which(cga2018[i]== 0)) !=0 )
        print( col.nbr[i] )
```

En relación al atributo _**NOx**_, en el siguiente segmento se aprecia que son muy pocos registros los que muestran afectación, existiendo observaciones de modelos/versiones previos del mismo fabricante, que exhiben valor para el atributo. 

```{r Verificación de atributos inicializados a Cero - atr NOx - identificación y consulta}
### Identificación y Consulta de registros con Valores incorrectamente inicalizados a Cero para atributo NOx
###
cga2018[  which(cga2018$NOx == 0), atr2show]

head(cga2018[  which(cga2018$NOx != 0 & cga2018$submarca == "FUSION"), atr2show], 10)
head(cga2018[  which(cga2018$NOx != 0 & cga2018$submarca == "COOPER S"), atr2show], 10)
```

Lo anterior nos induce a pensar que el caso se refiere a un valor perdido (inicializado con el centinela de valor cero), y que debe ser corregido. Para ello se utilizará más adelante una aproximación tipo **kNN**. 

Haciendo extensivo el analisis al atributo _**GEI**_, aplicando el mismo reazonamiento ilustrado 
anteriormente para el atributo _**NOx**_, resulta sencillo cuantificar el número de registros afectados por la presencia de valores perdidos para dicho campo. 

```{r Verificación de atributos inicializados a Cero - atr GEI - cuantificacion  }
### Cuantificación de registros con Valores incorrectamente inicializaciones a Cero (GEI)
###
length( which( cga2018$GEI == 0 & cga2018$NOx != 0  & cga2018$CO2 != 0 ) )
```

La existencia de observaciones con modelos y versiones previos del mismo fabricante (con valores distintos de cero para el atributo), aunado a que se tienen observaciones con el atributo inicializado a 0.00, que exhiben valor para el atributo _**CA**_, inducen a pensar de que este tipo de casos constituyen una contradicción (inconsistencia). 

En el segmento que sigue se adelanta una muestra de la consulta que apoya la argumentación, así como de la cuantificación de los registros afectados por la inicialización a cero para el atributo _**GEI**_, en ocasión de ausencia y presencia de valor en el  atributo _**CA**_, respectivamente.

```{r Verificación de atributos inicializados a Cero - atr cga2018$GEI - Consulta }
### Consulta de registros con Valores incorrectamente inicializados a Cero para atributo cga2018$GEI
###
atr2show <- c(atr2show,  "CA")
head( cga2018[  which(  cga2018$GEI == 0
                      & cga2018$NOx != 0 
                      & cga2018$CO2 != 0
                      & cga2018$CA != 0 ), atr2show], 
      10)
```

```{r Verificación de atributos inicializados a Cero - atr cga2018$GEI - Cuantificacion }
### Cuantificación de registros con Valores inicializados a Cero para atributo cga2018$GEI
### en presencia de valores asignados al atributo cga2018$CA
###
length( which( cga2018$GEI == 0 & (cga2018$NOx != 0 | cga2018$CO2 != 0) 
                                & (is.na(cga2018$CA) != TRUE ) ) )

### Cuantificación de registros con Valores inicializados a Cero para atributo cga2018$GEI
### en ausencia de valor en el atributo cga2018$CA
###
length( which( cga2018$GEI == 0 & (cga2018$NOx != 0 | cga2018$CO2 != 0) 
                                & (is.na(cga2018$CA) == TRUE ) ) )
```

El número de observaciones con el atributo _**GEI**_ igual a cero es de 411 registros, que representa algo menos el 10% de la muestra. Aunque es una proporción significativa desde el punto de vista del tamaño de nuestro juego de datos, tiene sentido tratar de imputar el valor.

Los datos del ejercicio están clasificados por una serie de atributos categóricos, que junto con consideraciones propias del dominio del problema, pueden ser de valor a los efectos de aplicar algún procedimiento para la imputación de valores. 

En este sentido, parece razonable tratar de resolver estos valores para el atributo, teniendo en cuenta información del Fabricante (_**marca**_) y del producto (_**submarca**_), combinados con otras variables incluidas en la muestra. 

Siguiendo el lineamiento adelantado en relación a la resolución de valores perdidos para el atributo _**NOx**_, se utilizará igualmente la aproximación  **kNN** para la resolución requerida por el atributo _**GEI**_.

El siguiente segmento aplica el procedimiento, creando previamente una copia de los datos y suprimiendo las columnas que podrían introducir ruido en la resolución, a causa del nivel de especificidad que introducen en el conjunto de datos.

```{r Resolucion de valores perdidos (inicializados a Cero) - atr NOx y GEI, warning=FALSE }
### Resolución de valores perdidos (inicializados a Cero) - atr NOx y GEI
###

# Supresión de Versión, Modelo y Calificación Contaminación Aire
cga2018.dat <- cga2018[ c(-3,-4,-18)] 

# Adecuación de datos para el procedimiento : Sustitución de Ceros por NA
cga2018.dat[  which(cga2018$NOx == 0), "NOx"] <- NA  

cga2018.dat[  which(  cga2018$GEI == 0
                    & cga2018$NOx != 0 
                    & cga2018$CO2 != 0 ), "GEI"] <- NA         

# Ejecución del procedimiento con un número impar de Vecinos (k)
cga2018.imp <- kNN(cga2018.dat, k=5)
```

Verificación de atributos con ajustes sugeridos por el método de imputación

```{r Verificación de columnas con valores de imputación - atr NOx y GEI }
### Verificación de columnas con valores de imputación calculadas con kNN
###
col.nbr <- col.nbr[ c(-3,-4,-18)] # Supresión de Versión, Modelo y Calificación Contaminación Aire 

### La matriz de resulados de la imputación dobla la cantidad de columnas originales
### por lo que se reajustan los índices para el recorrido adecuado de las columnas
##
desde <- length(col.nbr) + 1
hasta <- length(col.nbr) * 2

for(i in desde:hasta )
   if ( sum( cga2018.imp[i] == TRUE ) != 0 )
      print( col.nbr[i - length(col.nbr)] )
```

Traslación de los estimados obtenidos para los atributos _**NOx**_ y _**GEI**_, inicializados con centinelas de valor cero.

```{r Imputación de atr NOx y GEI }
### Imputación de los atributos NOx y GEI
###
copiar.imp <- which(cga2018.imp$NOx_imp == TRUE)
cga2018$NOx[ copiar.imp ] <- cga2018.imp$NOx[ copiar.imp ]

copiar.imp <- which(cga2018.imp$GEI_imp == TRUE)
cga2018$GEI[ copiar.imp ] <- cga2018.imp$GEI[ copiar.imp ]
```

Habiendo concluido la imputación de la variable _**GEI**_, resulta conveniente proceder a su conversión al tipo factor, tal como se adelantaba en las secciones iniciales.

```{r Conversion a tipo factor de GEI }
### Conversión del atributo GEI a tipo factor
###
cga2018$GEI <- factor( cga2018$GEI )
```

## 4.2 Reducción por Simplificación de Valores
El factor representado por la variable _**trans**_ puede ser objeto de una simplificación importante al sustituir los tipos específicos y modelos de transmisión, por la categoría a la que pertenece cada modelo incluido en el set de datos. De esta manera, reduciremos el número de niveles del factor de alrededor de 20 a tan solo 5.

Para ello nos apoyamos en una breve investigación, que nos permite resumir el conjunto de transmisiones utilizadas en el set de datos a sus tipos generales: 

  * Manual, 
  * Automática, 
  * Manual Robotizada, 
  * Variación Continua, y 
  * Doble Embrague 
 
```{r Reducción del factor trans }
### Reducción del factor trans con los Tipos de Transmisión Generales
###

cga2018$trans <- as.character(cga2018$trans)

cga2018[ which( cga2018$trans == "ASG" 
              | cga2018$trans == "DUALOGIC" 
              | cga2018$trans == "G TRONIC" 
              | cga2018$trans == "R TRONIC" 
              | cga2018$trans == "S TRONIC" 
              | cga2018$trans == "S TRONIC 7" 
              | cga2018$trans == "STRONIC" 
              ), 
        "trans" ] <- "Manual.Robot"

cga2018[ which( cga2018$trans == "AUT" 
              | cga2018$trans == "TIP" 
              | cga2018$trans == "TIP 8" 
              | cga2018$trans == "TIPT" 
              | cga2018$trans == "TIPTRONIC" 
              | cga2018$trans == "ZF SPEED QUICKSHIFT" 
              ), 
        "trans" ] <- "Auto"

cga2018[ which( cga2018$trans == "CVT" 
              | cga2018$trans == "MULTIT" 
              | cga2018$trans == "MULTITRONIC" 
              ), 
        "trans" ] <- "Var.Continua"

cga2018[ which( cga2018$trans == "M5" 
              | cga2018$trans == "M6" 
              | cga2018$trans == "MAN 6" 
              | cga2018$trans == "MAN" 
              ), 
        "trans" ] <- "Manual"

cga2018[ which( cga2018$trans == "DCT" 
              | cga2018$trans == "DKG" 
              | cga2018$trans == "DSG" 
              | cga2018$trans == "PDK" 
             ), 
        "trans" ] <- "Dbl.Embrague"

cga2018$trans <-factor( cga2018$trans )

## Niveles resultantes para el factor
levels(cga2018$trans)
```


## 4.3. Identificación y Tratamiento de Valores Extremos

A título de referencia se describe cuantitativamente la muestra.

```{r Explorando estadísticas descriptivas  de los atributos de la muestra}
### Explorando algunas estadisticas asociadas a los atributos de la muestra
###
summary(cga2018$pot)
summary(cga2018$tam)
summary(cga2018$r.Ciudad)
summary(cga2018$r.Carretera)
summary(cga2018$r.Comb)
summary(cga2018$r.Ajust)
summary(cga2018$CO2)
summary(cga2018$NOx)
```

Siendo relativamente pocos los atributos numéricos que componen la muestra, podemos graficar para cada uno de ellos diagramas de caja, de violín y de cuantiles vs cuantiles. La idea es tratar de visualizar la presencia de outliers, la forma aproximada de las distribuciones en la que se presentan los valores de cada campo, y facilitar una identificación preliminar de la presencia de posibles distribuciones normales.

```{r Boxplot de Vi a toda la muestra, echo=FALSE, fig.height=12, fig.width=12}
##### boxplot, vioplot y qqnorm 
par(mfrow=c(4,6))
par(cex=0.75)

out.pot <- boxplot.stats(cga2018$pot)$out  # outlier values.
boxplot(cga2018$pot, main ="Potencia")
vioplot(cga2018$pot)
qqnorm(cga2018$pot)
qqline(cga2018$pot)

out.tam <- boxplot.stats(cga2018$tam)$out  # outlier values.
boxplot(cga2018$tam, main ="Capacidad")
vioplot(cga2018$tam)
qqnorm(cga2018$tam)
qqline(cga2018$tam)

out.r.Ciudad <- boxplot.stats(cga2018$r.Ciudad)$out  # outlier values.
boxplot(cga2018$r.Ciudad, main ="Recorrido Ciudad")
vioplot(cga2018$r.Ciudad)
qqnorm(cga2018$r.Ciudad)
qqline(cga2018$r.Ciudad)

out.r.Carretera <- boxplot.stats(cga2018$r.Carretera)$out  # outlier values.
boxplot(cga2018$r.Carretera, main ="Recorrido Carretera")
vioplot(cga2018$r.Carretera)
qqnorm(cga2018$r.Carretera)
qqline(cga2018$r.Carretera)

out.r.Comb <- boxplot.stats(cga2018$r.Comb)$out  # outlier values.
boxplot(cga2018$r.Comb, main ="Recorrido Combustible")
vioplot(cga2018$r.Comb)
qqnorm(cga2018$r.Comb)
qqline(cga2018$r.Comb)

out.r.Ajust <- boxplot.stats(cga2018$r.Ajust)$out  # outlier values.
boxplot(cga2018$r.Ajust, main ="Recorrido Ajustado")
vioplot(cga2018$r.Ajust)
qqnorm(cga2018$r.Ajust)
qqline(cga2018$r.Ajust)

out.CO2 <- boxplot.stats(cga2018$CO2)$out  # outlier values.
boxplot(cga2018$CO2, main ="Dióxido de Carbono")
vioplot(cga2018$CO2)
qqnorm(cga2018$CO2)
qqline(cga2018$CO2)

out.NOx <- boxplot.stats(cga2018$NOx)$out  # outlier values.
boxplot(cga2018$NOx, main ="Oxido Nitroso")
vioplot(cga2018$NOx)
qqnorm(cga2018$NOx)
qqline(cga2018$NOx)
```

Los diagramas de violín que corresponde a cada variable nos permiten apreciar su forma aproximada, y darnos una idea acerca de su simetría En nuestro caso, todas sin excepción aparecen con alguna punta truncada, por lo que la normalidad de las distribuciones pudiera estar bastante cuestionada. 

Esto se corrobora con los gráficos "quantile vs quantile" (qq) que se ha incorporado para cada variable. En ellos se observa que en el mejor de los casos, la adherencia a la diagonal se afecta por distorsiones en los extremos o en el centro. 

Lo anterior nos obliga a validar la normalidad de estas variables con técnicas numéricas, aspecto que se aborda en sucesivos apartes.

En otro orden de ideas, las colas que se aprecian en los diagramas de caja, evidencian la presencia de valores extremos; siendo los casos con mayor ocurrencia los de los atributos _**CO2**_ y _**NOx**_, tal como se muestra de seguido.

```{r Outliers para Vi de toda la muestra,  fig.height=6, fig.width=12}
##### Número de observaciones fuera del intervalo definido por 1.5*IQR para cada variable numérica
##
out.Vi <- c(  length(out.pot),    length(out.tam),     length(out.r.Ciudad), length(out.r.Carretera),  
              length(out.r.Comb), length(out.r.Ajust), length(out.CO2),      length(out.NOx) )
out.Vi
```

En el ejemplo que nos ocupa, se reportan diversos tipos de vehículos (modelos dirigidos al mercado masivo, así como otros de alta gama), obviamente con características distintas. Particularmente los modelos de lujo de marcas prominentes, ofrecen versiones con prestaciones muy por encima de las utilizadas por los modelos más económicos. 

Esta segmentación es la primera causa de diferencias tan pronunciadas en los casos identificados, en atributos como la _**potencia**_ y la _**capacidad**_ del motor (_**tamaño**_), que a su vez repercuten sobre el rendimiento del vehículo en relación al consumo de combustible.

Así mismo, una breve revisión en relación a la emisión de _**CO2**_ y _**NOx**_, nos permite apreciar que los motores **Diesel** son los que en promedio reportan altos valores para estos atributos, seguidos luego por modelos gran _**potencia**_ a _**Gasolina**_. 

Por lo anterior se puede argüir que por razones del domino del problema, podría ser contraproducente hacer conjeturas en cuanto a la conveniencia y validez de las acciones para resolver los casos de "outliers" bajo sospecha (por la inspección anterior). 

Luego, una primera aproximación (conservadora) sugiere asumirlos como válidos; por lo tanto, una alternativa es la de no descartarlos o imputarlos, y proseguir con el ejercicio. 

<<< Atención>>>
Más adelante se reconsidera la necesidad o conveniencia de mantener el atributo _**Combustible**_, cuya resolución incide favorablemente en la atenuación de la eventual distorsión producto de la presencia de outliers en los campos _**NOx**_ y _**CO2**_.

## 4.4 Exportación de Datos Procesados
Realizadas las correcciones y ajustes que se han estimado adecuadas para la preparación de los datos, antes de proceder con su procesamiento, se sigue la exportación de una versión depurada.

```{r Exportación de datos depurados }
#### Exportación de datos depurados
##
write.csv2(cga2018, "./../dat/clean/Consumo Gasolina Autos Ene 2018 - clean.csv")
```


## 4.5 Distribución de la Variable de Respuesta

Con el objetivo de confeccionar un modelo que permita la clasificación de observaciones, en categorías correspondientes a cada nivel del factor de calificación de  _**Contaminación del Aire**_, se dedica esta sección a revisar brevemente cómo se distribuye la variable _**CA**_ dentro de la muestra, y con respecto a otros atributos.

```{r Distribución de la variable de Respuesta CA }
### Distribución de la variable de Respuesta CA
###
ggplot(data = cga2018, aes(x = CA, y = ..count.., fill = CA)) +
  geom_bar() +
  scale_fill_hue(l=40, c=35) +
  labs(title = "Calificación de Contaminación del Aire") +
  theme_bw() +
  theme(legend.position = "bottom")
```

Acompañamos la gráfica con las frecuencias observadas y  las proporciones en que ocurre cada nivel del factor

```{r Tabla de frecuencias de CA }
### Tabla de frecuencias de la variable de Respuesta CA
### 
table(cga2018$CA)
prop.table(table(cga2018$CA)) %>% round(digits = 4)
```

El resultado revela un fuerte desequilibrio en relación a la forma en que se distribuyen las proporciones de la variable calificación de _**Contaminación de Aire**_ sobre la muestra, concentrando la mayor cantidad de marcas, modelos y versiones en las categorías más altas.

### 4.5.1 Simplificación de la Variable de Respuesta
Para la variable de respuesta **CA** se tiene una distribución, en la que los valores iniciales de la escala (hasta el 5) prácticamente no se diferencian (siendo su volumen bastante bajo);  así como también, para los niveles del segmento de la escala que van del valor 6 al 8, los valores observados son igualmente homogéneos.

Considerando esta distribución particular, parece razonable proponer la simplificación de la escala para la variable, consolidando los valores de manera de contar tan solo con tres niveles, de acuerdo al siguiente arreglo:

  * Grupo de Contaminación de Aire **Baja**, integrada por las observaciones con valores del 1 al 5.
  * Grupo de Contaminación de Aire **Moderada**, que incluye las que exhiben valores entre 6 y 8.
  * Grupo de Contaminación de Aire **Alta**, para las observaciones con valor 9.

El siguiente segmento, ejecuta la simplificación propuesta:

```{r Reducción del factor CA  }
### Reducción del factor CA con la convención: Baja (1), Moderada (2) y Alta (3)
###

cga2018$CA <-as.integer( cga2018$CA )

cga2018[ which( cga2018$CA >= 1 & cga2018$CA <= 5 ), "CA" ] <- 1
cga2018[ which( cga2018$CA >= 6 & cga2018$CA <= 8 ), "CA" ] <- 2
cga2018[ which( cga2018$CA == 9                   ), "CA" ] <- 3

cga2018$CA <-factor( cga2018$CA )
```

Donde se representa con el valor 1 la clase de Contaminación de Aire **Baja**, con el valor 2 la 
**Moderada**, y finalmente la **Alta** con el valor 3.

## 4.6 Distribución de Variables Categóricas

El siguiente aparte está dirigido a visualizar cómo se distribuye la variable de respuesta con respecto a cada una de las variables categóricas de la muestra, que han sido consideradas como con potencial para influir sobre el resultado de un eventual modelo de clasificación.

```{r Grafica distribucion de CA sobre categoricas}
### Gráfica de la distribución del atributo CA sobre el Número de Cilindros
### 

library(gridExtra)

ggplot(data = cga2018, aes(x = cil, y = ..count.., fill = CA)) +
              geom_bar() +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Número de Cilindros") +
              theme_bw() +
              theme(legend.position = "bottom")

```

El mayor volumen de modelos se concentra en la categoría de cuatro cilindros, seguidas a distancia por los segmentos de seis y ocho cilindros. En general no se aprecia una cobertura uniforme sobre las categorías de la variable _**Contaminación del Aire**_.

Para facilitar la interpretación de la gráfica, se anexa la tabla de frecuencia y proporciones correspondientes a cada categoría:

```{r Frecuencia y Proporciones de CA sobre cilindros - Número de Cilindros}
### Frecuencia y Proporciones de la distribución del atributo CA sobre la variable cil
### 
# Tabla de frecuencias relativas a la Contaminación del Aire por Cilindro
table(cga2018$cil, 
      cga2018$CA,
      dnn=c("# Cilindros","Contaminación del Aire"))

# Tabulación de proporciones 
prop.table(table(cga2018$cil, cga2018$CA), margin = 1) %>% round(digits = 2)
```

Para el caso de la variable relacionada al _**Número de Cilindros**_ se hace evidente el desequilibrio de la distribución por categoría de  _**Contaminación de Aire**_ (claramente sesgado hacia los valores altos de la clasificación).

La gráfica por Tipo de Transmisión, presenta un comportamiento similar a la anterior, con una concentración mayor de modelos construidos con cajas de cambio Automáticas; pero con una distribución más proporcionada sobre las categorías de _**Contaminación del Aire**_.

```{r Grafica distribucion de CA sobre categoricas - Tipos de Transmisión}
### Gráfica de la distribución del atributo CA sobre el Tipos de Transmisión
### 
ggplot(data = cga2018, aes(x = trans, y = ..count.., fill = CA)) +
              geom_bar() +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Tipos de Transmisión") +
              theme_bw() +
              theme(legend.position = "bottom")
```

Sigue la tabulación de frecuencias y proporciones observadas en la muestra:

```{r Frecuencia y Proporciones de CA sobre transmision}
### Frecuencia y Proporciones de la distribución del atributo CA sobre la variable trans
### 
# Tabla de frecuencias relativas a la Contaminación del Aire por Tipo de Transmisión
table(cga2018$trans, 
      cga2018$CA,
      dnn=c("Tipo de Transmisión","Contaminación del Aire"))

# Tabulación de proporciones 
prop.table(table(cga2018$trans, cga2018$CA), margin = 1) %>% round(digits = 2)
```

En el caso del _**Tipo de Transmisión**_, aunque persiste el desbalance en la distribución con respecto a las categorías de _**Contaminación del Aire**_, el efecto se percibe más atenuado.

Para cerrar la sección se presenta la gráfica correspondiente a la variable de _**Calificación de Emisión de Gases de Efectos Invernadero**_

```{r Grafica distribucion de CA sobre categoricas - Emision de Gases EI}
### Gráfica de la distribución del atributo CA sobre la Calificación de Emisión de Gases EI
### 
ggplot(data = cga2018, aes(x = GEI, y = ..count.., fill = CA)) +
              geom_bar() +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Emisión Gases/Invernadero") +
              theme_bw() +
              theme(legend.position = "bottom")
```

Esta variable se aprecia mejor distribuida en el rango de categorías de la variable _**Contaminación del Aire**_; sin embargo, debido a su carácter estructural, el desbalance en la distribución persiste como puede apreciarse en la poca presencia sobre la categoria _**CA**_ **Baja** (1) para niveles bajos de **Emisión de GEI**, que se confirma en las tabulaciones de frecuencia y proporciones que sigue:

```{r Frecuencia y Proporciones de CA sobre GEI}
### Frecuencia y Proporciones de la distribución del atributo CA sobre la variable GEI
### 
# Tabla de frecuencias relativas a la Contaminación del Aire por categoria de Emisión de GeI
table(cga2018$GEI, 
      cga2018$CA,
      dnn=c("Emisión de Gases EI","Contaminación del Aire"))

# Tabulación de proporciones 
prop.table(table(cga2018$GEI, cga2018$CA), margin = 1) %>% round(digits = 2)
```


## 4.7 Distribución de Variables Continuas

Se presume la existencia de una relación (de mucha relevancia) entre la variable de respuesta para la calificación de la _**Contaminación del Aire**_, y los atributos continuos relacionados a la medición de emisiones a la atmosfera (_**CO2**_ y _**NOx**_). 

Para darnos una idea en cuanto a la manera en que se distribuye cada una de estas variables, en relación a cada una de las categorías representada por los niveles del atributo _**CA**_, en lo que sigue se grafican sus funciones de densidad, por categoría de _**CA**_

```{r Grafica de densidades de CO2 sobre categorias de CA}
### Gráfica de densidad de CO2 sobre categorías del atributo CA 
### 
ggplot(data = cga2018, aes(x = CO2, fill = CA)) +
              geom_density(alpha = 0.5) +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Emisión de CO2") +
              theme_bw()
```

Se aprecian formas de distribuciones bastante disparejas entre categorías de la variable de respuesta, quizá producto de la pronunciada diferencia en la cantidad de casos por clase; pero con una tendencia a concentrarse en un entorno del valor de los 200 gr/Km. 

```{r Grafica de densidades de NOx sobre categorias de CA}
### Gráfica de densidad de NOx sobre categorias del atributo CA 
### 
ggplot(data = cga2018, aes(x = NOx, fill = CA)) +
              geom_density(alpha = 0.5) +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Emisión de NOx") +
              theme_bw()
```

En esta otra variable, también vemos  como varia la forma de la distribución por categoría de la variable de respuesta, pero asistimos a una propagación de los distintos grupos a lo largo del eje horizontal, que hace pensar en una posible diferencia de medias (importante en caso de aplicar algoritmos de clasificación).

Extendiendo la inspección gráfica al resto de las variables contínuas de interés, tenemos:

La variable _**potencia**_ exhibe un comportamiento similar, con formas de distribución disparejas por categoría de respuesta, con una concentración de modelos de baja potencia.

```{r Grafica de densidades de pot sobre categorias de CA}
### Gráfica de densidad de pot sobre categorías del atributo CA 
### 
ggplot(data = cga2018, aes(x = pot, fill = CA)) +
              geom_density(alpha = 0.5) +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Potencia") +
              theme_bw()
```

El atributo _**tam**_ no es la excepción, y muestra un conducta similar a las anteriores, mostrando que la oferta de modelos está concentrada en motores con capacidad de alrededor de 2 litros.

```{r Grafica de densidades de tam sobre categorias de CA}
### Gráfica de densidad de tam sobre categorías del atributo CA 
### 
ggplot(data = cga2018, aes(x = tam, fill = CA)) +
              geom_density(alpha = 0.5) +
              scale_fill_hue(l=40, c=135) +
              labs(title = "tamaño") +
              theme_bw()
```

Finalmente, para el _**rendimiento en Ciudad**_ tenemos una situación muy paracida, con bastante más difererncia en las formas de las distribuciones parciales, con una aparente concentración alrededor de los 12 Km por litro.

```{r Grafica de densidades de r.Ciudad sobre categorias de CA}
### Gráfica de densidad de r.Ciudad sobre categorías del atributo CA 
### 
ggplot(data = cga2018, aes(x = r.Ciudad, fill = CA)) +
              geom_density(alpha = 0.5) +
              scale_fill_hue(l=40, c=135) +
              labs(title = "Rendimiento en Ciudad") +
              theme_bw()
```


Un aspecto particularmente llamativo es la manera en que los valores NA sobre la variable de respuesta _**CA**_ tiende a cubrir algunos segmentos de los grupos graficados. La ausencia de observaciones completas en las proporciones observadas sobre éstos atributos, puede tener un efecto adverso en relación a la capacidad predictiva de dichas variables.


## 4.8 Selección de Atributos de la Muestra

La siguiente tabulación de niveles de _**Emisión de Gases de Efecto Invernadero**_, por calificación de _**Contaminación de Aire**_ nos permite apreciar mejor el efecto de la ausencia de valores (inicializados a cero) sobre los niveles de emisión _**GEI**_, para la categoria **Baja** de  _**CA**_, que hace evidente un desbalance en la muestra.

```{r Tabulación CA vs GEI}
##### Tabulación: Calificación de Contaminación de Aire vs Calificación de Gases de Efecto Invernadero 
##
table(cga2018$CA, cga2018$GEI, dnn=c("Contaminación del Aire","Gases de Efecto Invernadero"))
```

El total de valores tabulados por _**Emisión de Gases de Efecto Invernadero**_ es de 3379 observaciones para la variable, que excluye las 1238 observaciones que corresponden a calificaciones de  _**Contaminación de Aire**_ con valores perdidos.

Sigue la extracción de observaciones para constituir el set de datos para la confección del modelo, orientado a la estimación de la _**Contaminación del Aire**_. Con ello se deja aparte al conjunto de observaciones que no reportan valores en este atributo, y que luego podrían ser utilizadas para la generación de predicciones al respecto (siempre que sea compatibles con las condiciones del modelo).

```{r Extraccion de filas correspondientes a observaciones completas }
##### Extracción de filas correspondientes a observaciones completas 
##
cga2018.dat <- cga2018[ which( is.na(cga2018$CA) != TRUE ), ]
nrow(cga2018.dat)
```

Producto de la reducción de filas, una revisión de las proporciones a través de una tabulación simple de variables categóricas del set, revela que la variable _**comb**_ deja de tener una distribución por niveles (**Diesel**, **Gasolina**) que resulte relevante o razonable para su consideración

```{r Tabulación de variables categoricas del set }
##### Tabulación de variables categóricas del set 
##
table(cga2018.dat$trans,
      cga2018.dat$cil,
      cga2018.dat$comb, 
      dnn=c("Tipo Transmisión","# Cilindros Invernadero","Tipo Combustible"))
```

El tipo de combustible tendrá que ser erradicado del estudio, ya que al eliminar las observaciones referentes a valores perdidos del atributo  _**Contaminación del Aire**_, se pierde casi la totalidad de la representación del estrato **Diesel**. 

Esta circunstancia está relacionada con la observación adelantada en la sección Distribución de Variables Continuas, en la que se menciona el solapamiento de observaciones con valores perdidos sobre la variable de respuesta _**CA**_, sobre otras variables como la _**Potencia**_ el _**Tamaño**_.

Colateralmente, estas medidas de eliminación de observaciones, contribuyen a disminuir el efecto de la presencia de presuntos valores outlier en las columnas _**CO2**_ y _**NOx**_, producto a su vez de la presencia de motores **Diesel** en la muestra. Sin embargo, esta medida afecta sensiblemente la capacidad predictiva del modelo que se obtenga, ya que no estará en capacidad de predecir correctamente observaciones que correspondan a modelos que consuman este tipo de combustible.

Habiendo ajustado e imputado los valores de los atributos considerados como afectados por inconsistencias o por la presencia de valores perdidos, de seguido se suprimen los atributos que no constituyen características técnicas del vehículo, sino que forman parte de su identificación o descripción. 

En este sentido, junto con la columna _**comb**_ se eliminan las columnas de carácter descriptivo: _**marca**_, _**submarca**_, _**ve**_ (versión), _**modelo**_ y  _**categoría**_.
  
```{r Supresión de atr de identificación }
##### Supresión de atributos Descriptivos: 
##    Marca, Submarca, Versión, Modelo, Categoría y Combustible
##
cga2018.dat <- cga2018.dat[ which( cga2018.dat$comb != "Diesel" ), ]

cga2018.dat <- cga2018.dat[ c(-1, -2, -3, -4, -6, -10)]
str(cga2018.dat)
```


## 4.9 Normalización de Variables Numéricas

Como parte de las tareas de Limpieza y adecuación de datos, incluimos el escalamiento de las variables numéricas, de manera que en caso de aplicar métodos que impliquen cálculo de distancias, la diferencia de escalas no distorsione el resultado.

```{r Escalamiento de Variables numéricas }
### Escalamiento de variables numéricas
###

normalizar <- function(data){ return (data - min(data))/(max(data) - min(data))}
normalizar_0 <- function(data){ return (data - mean(data))/(sd(data))}

cga2018.dat$pot <- normalizar(cga2018.dat$pot)
cga2018.dat$tam <- normalizar(cga2018.dat$tam)

cga2018.dat$r.Ciudad <- normalizar(cga2018.dat$r.Ciudad)
cga2018.dat$r.Comb   <- normalizar(cga2018.dat$r.Comb)
cga2018.dat$r.Ajust  <- normalizar(cga2018.dat$r.Ajust)
cga2018.dat$r.Carretera <- normalizar(cga2018.dat$r.Carretera)

cga2018.dat$CO2 <- normalizar(cga2018.dat$CO2)
cga2018.dat$NOx <- normalizar(cga2018.dat$NOx)

```

# 5. Análisis de los Datos.


## 5.1. Selección de Grupos a Analizar/Comparar

Siendo el propósito de la investigación, la confección de un modelo que permita **validar la calificación de nuevos vehículos en términos de su impacto ambiental** mediante la estimación de su potencial de **Contaminación de Aire**, la siguiente sección hará foco en extraer toda la información posible de la muestra, a efectos de orientar la selección y prueba de tipos de modelos, que resulten más adecuados a los efectos de cubrir el objetivo que nos hemos trazado. 

Si bien, habiendo excluído el _**Tipo de Combustible**_, las variables categóricas restantes _**Tipo de Transmisión**_, _**Número de Cilindros**_ y _**Emisión de Gases de Efecto Invernadero**_, pueden ser de utilidad para la conformación de grupos que puedan ayudar a entender el comportamiento del modelo; resulta de mayor relevancia comprender el comportamiento de los datos en función a los niveles reportados de **CA**.

Por consiguiente, la caracterización más importante y referencia principal para la tarea de comparaciones y análisis estadísticos, estarán planteadas en función a la agrupación propuesta por la reducción aplicada sobre los Niveles de la variable de Respuesta _**CA**_: **Baja**, **Moderada** y **Alta**.

_Análisis a Aplicar_.

  * Verificación de la existencia de distribuciones normales en las variables continuas incluidas en la muestra. Aunque la impresión hasta ahora es que no hay columnas en la muestra que responda a una distribución normal, es necesario aplicar un método numérico para confirmarlo.

  * Verificación de la condición de homogeneidad de varianza de los atributos continuos, para los grupos que resultan de la segmentación de la variable de respuesta.

  * Verificación de la existencia de relaciones entre las columnas del set de datos, mediante la revisión de posibles correlaciones entre ellas. La idea es determinar condiciones de independencia, y evitar redundancias en la selección final de atributos.

  * Validación por contraste de hipótesis de las Medias de las variables continuas en las que se aprecie homogeneidad sobre los distintos niveles de la variable de salida.

## 5.2. Comprobación de Normalidad y Homogeneidad de varianza.

### 5.2.1 Normalidad: Test Shapiro-Wilk
La condición de distribución normal de las variables tiene incidencia en las pruebas de inferencia y contraste de significancia de los parámetros de los distintos modelos. Sin embargo, el volumen de la muestra puede hacer menos sensibles los test a la ausencia de normalidad.

La apreciación obtenida a partir de las gráficas de cuantiles (qq), elaboradas para las variables numéricas en secciones previas, debe ser confirmada con los resultados derivados de métodos numéricos. 

Para efectos del ejercicio, en el que tenemos una muestra razonable (menos de 5.000 observaciones), utilizaremos el método Shapiro-Wilk, que estipulada como hipótesis nula la normalidad de la muestra:

```{r Test de Normalidad Shapiro-Wilk }
### Test de Normalidad Shapiro-Wilk para variables numéricas
###

nivel.significacion <- 0.05
col.nbr.dat <- colnames(cga2018.dat)
for(i in 1:ncol(cga2018.dat)){
   if (is.integer(cga2018.dat[ , i]) | is.numeric(cga2018.dat[ , i])) {
       pvlue <- shapiro.test(cga2018.dat[ , i])$p.value
       
       if (pvlue >= nivel.significacion) {
         print( sprintf("%11s : %8e *** ", col.nbr.dat[i], pvlue)  )
       }
       else {
         print( sprintf("%11s : %8e     ", col.nbr.dat[i], pvlue)  )
       }
    } 
}
```

El listado de los p-valor resultantes, obtenidos para cada una de las columnas evaluadas, nos obliga a rechazar la hipótesis de normalidad para cada uno de los atributos enumerados, tal como se había anticipado al revisar las gráficas qq, en la sección dedicada a la descripción de los datos.


### 5.2.4 Homoscedasticidad: Tests de Levene y de Fligner
Se aplicará la prueba de Levene de Homogeneidad de Varianza, sobre las variables continuas _**pot**_, _**Rendimiento en Ciudad**_ y _**NOx**_, que son las que hasta ahora parecen prometedoras en relación a su capacidad predictiva de la calificación de _**Contaminación de Aire**_, considerando los grupos determinados por los niveles _**Baja**_, _**Moderada**_,  y _**Alto**_.

```{r Evaluacion de Levene para Var.Continuas vs Variable de Respuesta  }
### Evaluación de Levene para Variables Continuas vs Variable de Respuesta 
###
leveneTest(y=cga2018.dat$pot, group=cga2018.dat$CA, center="median")
leveneTest(y=cga2018.dat$r.Ciudad, group=cga2018.dat$CA, center="median")
leveneTest(y=cga2018.dat$NOx, group=cga2018.dat$CA, center="median")
```


Los resultados obtenidos de la aplicación de la prueba sobre la variable _**pot**_, resulta en un  p-valor por debajo del nivel de significación de 0.05, que nos lleva a rechazar la hipótesis nula del test (de igualdad de varianza) de la variable, con respectos a los grupos definidos por la variable de respuesta.

Para las variables _**rendimiento en Ciudad**_ y _**NOx**_ observamos el mismo resultado.

La aplicación de la prueba de Fligner (no paramétrica, y no sensible a la ausencia de normalidad de los atributos) arroja resultados similares en cuanto a la heteroscedasticidad de la muestra:

```{r Evaluacion de filgner para Variables Continuas vs Variable de Respuesta }
### Evaluación de Filgner para Variables Continuas vs Variable de Respuesta 
###
fligner.test(pot ~ CA, data= cga2018.dat)
fligner.test(r.Ciudad ~ CA, data= cga2018.dat)
fligner.test(NOx ~ CA, data= cga2018.dat)
```

En todos los casos, el p-valor obtenido en la prueba está por debajo del nivel de significación fijado.

En conclusión, las variables continuas analizadas tienen varianza distinta en al menos alguno de los niveles, en el dominio de la variable categórica utilizada para la definición de los grupos de interés. 

Por lo tanto, para todos los casos probados (en ambas pruebas), se rechaza la hipótesis nula en beneficio de la alternativa, que establece la hetereoscedasticidad de las variables para cada uno de los grupos.


## 5.3. Aplicación de Pruebas Estadísticas.

Producto de la ausencia de normalidad en las variables de la muestra, y la ausencia homoscedasticidad en los grupos propuestos, no puede aplicarse el análisis de varianzas a través de el procedimiento anova, para validar la homogeneidad de las medias a través de los grupos del factor.

Nos restringiremos a revisar las relaciones entre columnas, y de las columnas versus la variable de respuesta, a través del estudio de la correlación que pueda existir entre los atributos; así como, a revisar la media de las variables continuas más importantes, con respecto a la variable de respuesta.

### 5.3.1 Variables Continuas Correlacionadas con la Respuesta

Con el resultado de la sección anterior, se confirma que las variables de la muestra no responden a una distribución normal. En consecuencia, para evaluar la correlación deberá optarse por el test de Spearman. 

Sin embargo, la presencia de "tie values" impiden una correcta determinación de $\rho$ (rho), por lo que se ensaya el método de Kendall como alternativa, explorando la determinación de $\tau_{b}$ (tau) como indicador de correlación:

```{r Test de Correlación de Variable, warning=TRUE }
### Exploración de la Correlación entre variables numéricas
###

cga2018.dat$CA <- as.integer(cga2018.dat$CA)

col.nbr.dat <- colnames(cga2018.dat)
hasta <- ncol(cga2018.dat) - 1 # supresión de variable respuesta

for(i in 1:hasta){
  if (is.integer(cga2018.dat[ , i]) | is.numeric(cga2018.dat[ , i])) {
    cor.rslt <- cor.test(cga2018.dat[ , i], cga2018.dat$CA, method="kendall") 
    
    r <- cor.rslt$estimate
    pvlue <- cor.rslt$p.value
    
    if (pvlue >= nivel.significacion) {
      print( sprintf("%11s: p-vle=%8e  (tau=%8e)  (r^2=%8e) *** ", col.nbr.dat[i], pvlue, r, r*r)  )
    }
    else {
      print( sprintf("%11s: p-vle=%8e  (tau=%8e)  (r^2=%8e)    ", col.nbr.dat[i], pvlue, r, r*r)  )
    }
  } 
}

cga2018.dat$CA <- factor(cga2018.dat$CA)
```

La revisión del listado de resultado nos lleva  al siguiente conclusión: 

El atributo _**NOx**_ exhibe un valor estimado para el parámetro $\tau_{b}$ de 0.7, para un coeficiente de correlación de 0.57, que confirma su relación con la variable de respuesta. Sin embargo, para el resto de las variables, el coeficiente obtenido es bastante próximo a cero, lo que indica ausencia de correlación.

### 5.3.2 Correlación Entre Variables Continuas

La correlación entre las variables de la muestra, permiten determinar relaciones que pueden derivar en la simplificación de los datos por eliminación de redundancias. En este sentido, se hace la inspección de las correlaciones entre columnas, apoyados en la graficación de la matriz de correlaciones, tal como se ilustra de seguido:

```{r Gráfica de Correlación }
### Aproximación gráfica
###
aux <- data.frame(cga2018.dat$pot, 
                  cga2018.dat$tam, 
                  cga2018.dat$r.Ciudad, 
                  cga2018.dat$r.Carretera, 
                  cga2018.dat$r.Comb,
                  cga2018.dat$r.Ajust,
                  cga2018.dat$CO2,
                  cga2018.dat$NOx)

colnames(aux) <- c("Pot.", "Tam.", 
                   "R.Cdad", "R.Carr.", "R.Comb.", "R.Ajust",
                   "CO2", "NOx")

M <-cor(aux)
corrplot.mixed(M, upper = "ellipse", number.cex = .7, tl.cex = .7)
```

La gráfica revela que hay correlaciones entre pares de atributos, que nos permitirán simplificar el tamaño de la muestra: Tanto la _**potencia**_  como la _**capacidad**_ del motor (tamaño), están positivamente correlacionadas con la emisión de _**CO2**_.

Igualmente, el _**rendimiento en Ciudad**_, _**Carretera**_, por litro de _**Combustible**_ y su _**Ajuste**_ lo están entre sí, pero negativamente con los anteriores.

La variable correspondiente a la emisión de _**NOx**_, si evidencia una conducta independiente.

### 5.3.3 Media de Atributos por Categoría de Respuesta

De la revisión de la correlación entre las variables numéricas, resulta la simplificación del conjunto inicial, para continuar con los atributos _**CO2**_, _**NOx**_ y _**Rendimiento en Ciudad**_.

Media del atributo _**CO2**_ por nivel del factor de salida se lista de seguido:

```{r Inspección de la Media por Categoria de Respuesta - atr CO2  }
### Inspección de la Media por Categoría de Respuesta - atr CO2 
###
for (i in 1:length(levels(cga2018.dat$CA))) {
  j <- levels(cga2018.dat$CA)[i]
  print( paste( "Contaminación Aire: categoría ", 
                sprintf("(%s) %6.2f", j, mean(cga2018.dat$CO2[cga2018.dat$CA == j]) )) )
}
```

Media del atributo _**NOx**_ por nivel del factor de salida:

```{r Inspección de la Media por Categoria de Respuesta - atr NOx  }
### Inspección de la Media por Categoría de Respuesta - atr NOx 
###
for (i in 1:length(levels(cga2018.dat$CA))) {
  j <- levels(cga2018.dat$CA)[i]
  print(paste( "Contaminación Aire: categoría ", 
                sprintf("(%s) %6.2f", j, mean(cga2018.dat$NOx[cga2018.dat$CA == j]) )) )
}
```

Media del atributo _**rendimiento en Ciudad**_ por nivel del factor de salida:

```{r Inspección de la Media por Categoria de Respuesta - atr r.Ciudad  }
### Inspección de la Media por Categoría de Respuesta - atr r.Ciudad 
###
for (i in 1:length(levels(cga2018.dat$CA))) {
  j <- levels(cga2018.dat$CA)[i]
  print(paste( "Contaminación Aire: categoría ", 
                sprintf("(%s) %6.2f", j, mean(cga2018.dat$r.Ciudad[cga2018.dat$CA == j]) )) )
}
```

De los resultados obtenidos en los distintos listados previos, los atributos _**CO2**_ y _**NOx**_ parecen exhibir buenas diferencias en sus medias, por nivel del factor de salida. No obstante, la variable _**rendimiento en Ciudad**_ presenta valores bastante homogéneos. 

Para este último caso es pruedente verificar si la variación en la media observada por categoría es estadísticamente significativa, y decidir si el campo posee suficiente información para incorporarlo en el modelo de clasificación. 


_**Varia la media del rendimiento en Ciudad para el grupo de autos con CA de categoría Baja, con respecto al resto de la clasificación ?**_

Para responder a la pregunta se formarán los dos grupos, y se realizará un contraste de hipótesis para medias de dos muestras, especificando la condición de varianza desconocida y utilizando el nivel de significación del 0.05.

```{r Revisión de variacion de media - atr ciudad }
#### Comparación de la media del atributo r.Ciudad para los grupos superiores de CA
##   vs el grupo de calificación Baja
##
md.cdad.bajos <- subset(cga2018.dat, CA == 1, select=c(r.Ciudad))           
md.cdad.altos <- subset(cga2018.dat, CA == 2 | CA == 3, select=c(r.Ciudad)) 

t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)
```

El test se aplica en su la versión Welch (dos muestras con varianza desconocida), obteniendo un p-valor cercano a cero, que nos hace rechazar la hipótesis nula de igualdad de medias: Esto es, ambos grupos observan medias distintas.

Este resultado puede estar influido por la distribución de observaciones por categoría de _**CA**_ que hemos ya identificado en secciones previas. Por lo que cabe preguntarse lo siguiente:

_**Para el Rendimiento en Ciudad, varían entre si las medias entre pares de categorías?**_

Para este tipo de preguntas pudiera aplicarse el análisis de varianza (anova), si las condiciones estuvieran dadas; pero para nuestra muestra (sin normalidad y heteroscedasticidad), tendremos que aplicar el contraste de medias para muestras distintas a pares.

Repitiendo el mismo ejercicio previo (a pares de categoría de _**CA**_), se lista el conjunto de p-valores obtenido para la combinación de categorías ensayadas:

```{r Revisión de variacion de media categoria superior CA- atr ciudad }
#### Comparación a pares de la media del atributo r.Ciudad para los grupos superiores
##
md.cdad.bajos <- subset(cga2018.dat, CA == 1, select=c(r.Ciudad)) 
md.cdad.altos <- subset(cga2018.dat, CA == 2, select=c(r.Ciudad)) 

cat.1.vs.2 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

md.cdad.bajos <- subset(cga2018.dat, CA == 2, select=c(r.Ciudad)) 
md.cdad.altos <- subset(cga2018.dat, CA == 3, select=c(r.Ciudad)) 

cat.2.vs.3 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

md.cdad.bajos <- subset(cga2018.dat, CA == 1, select=c(r.Ciudad)) 
md.cdad.altos <- subset(cga2018.dat, CA == 3, select=c(r.Ciudad)) 

cat.1.vs.3 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

rslt <- cbind(cat.1.vs.2$p.value, cat.2.vs.3$p.value, cat.1.vs.3$p.value)
colnames(rslt) <- c("1.vs.2", "2.vs.3", "1.vs.3")
rslt
```

Si bien el valor-p para las comparaciones de las categorias **Moderada** (2) y **Alta** (3) en relación a la categoría **Baja** (1), habría que rechazar la hipótesis nula de igualdad de medias, el valor obtenido en la comparación entre las categorías (2) y (3), resulta por encima del nivel de significación, por lo que en este caso no puede rechazarse la igualdad de media entre.

Por lo anterior, el atributo _**rendimiento en Ciudad**_ podría no tener suficiente capacidad predictiva para diferenciar vehiculos entre niveles de _**Contaminación de Aire**_.

_**Varia la media del CO2 para el grupo de autos con CA para la categoría 1, con respecto al resto (2 y 3), para el subgrupo de autos de cuatro cilindros ?**_

Siendo siempre la intención la de evaluar la capacidad de discriminación del atributo versus la variable de respuesta, la pregunta va en línea con la intención original de utilizar las variables categóricas seleccionadas de la muestra para la determinar si existe alguna interacción adicional entre grupos, que pueda resultar de interés. 

Nuevamente, la imposibilidad de aplicar la técnica del anova nos restringe a procedimientos menos poderosos como el previo, y análisis más limitados.

Al igual que el caso del _**rendimiento en Ciudad**_ se toma los grupos categorías de _**CA**_, pero esta vez restringiéndolos por el _**Número de Cilindros**_, para finalmente aplicar el test:

```{r Revisión de variacion de media - atr CO2 }
#### Comparación de la media del atributo CO2 para los grupos superiores de CA (2,3)
##   versus los de categoría (1), en coches de 4 cilindros 
##
md.cdad.bajos <- subset(cga2018.dat, (CA==1)       & (cil==4),select=c(CO2))  
md.cdad.altos <- subset(cga2018.dat, (CA==2|CA==3) & (cil==4),select=c(CO2))   

t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)
```

Al igual que en el ejemplo previo, el test obliga a rechazar la hipótesis de igualdad de medias para ambos grupos (categorías **Bajas** de _**CA**_, versus la agrupación de las **Moderadas** y **Altas**). 

Al igual que antes, si bien para la categoría de Contaminación de Aire _**CA**_ **Baja** se observa una media en relación a la emisión de _**CO2**_  distinta a la que se tiene para el grupo combinado de categorías **Moderada** y **Alta**, debemos preguntarnos si entre la **Moderada** y la **Alta** se preserva la condición de medias distintas.

_**Dentro del grupo que concentra más ocurrencia de observaciones (grupo de categorías altas) serán distintas las medias del atributo CO2 entre las categorías ?**_

```{r Revisión de variacion de media categoria superior CA- atr CO2 }
#### Comparación a pares de la media del atributo CO2 para los grupos superiores
##   en autos de cuatro cilindros
##
md.cdad.bajos <- subset(cga2018.dat, CA==2 & cil==4, select=c(CO2)) 
md.cdad.altos <- subset(cga2018.dat, CA==3 & cil==4, select=c(CO2))

t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)
```

Se obtiene un p-valor que permite afirmar que no hay evidencia de que las medias de estas categorias sean significativamente distintas. 

_**Serán distintas las medias del atributo NOx entre las categorías CA, para coches con transmisión automática ?**_

El poco poder predictivo que intuímos para los atributos _**rendimiento Ciudad**_ y _**CO2**_, producto de las pruebas anteriores, nos conduce a cuestionarnos el potencial de la variable _**NOx**_. Por ella razón planteamos esta última pregunta, y aplicando el mismo enfoque previo:

```{r Revisión de variacion de media categoria superior CA- atr NOx }
#### Comparación a pares de la media del atributo NOx 
##   en autos de transmisión automática
##
md.cdad.bajos <- subset(cga2018.dat, CA==1 & trans=="Auto", select=c(NOx)) 
md.cdad.altos <- subset(cga2018.dat, CA==2 & trans=="Auto", select=c(NOx)) 

cat.1.vs.2 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

md.cdad.bajos <- subset(cga2018.dat, CA==2 & trans=="Auto", select=c(NOx)) 
md.cdad.altos <- subset(cga2018.dat, CA==3 & trans=="Auto", select=c(NOx)) 

cat.2.vs.3 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

md.cdad.bajos <- subset(cga2018.dat, CA==1 & trans=="Auto", select=c(NOx)) 
md.cdad.altos <- subset(cga2018.dat, CA==3 & trans=="Auto", select=c(NOx)) 

cat.1.vs.3 <- t.test( md.cdad.bajos, md.cdad.altos, var.equal=FALSE, paired=FALSE)

rslt <- cbind(cat.1.vs.2$p.value, 
              cat.2.vs.3$p.value, 
              cat.1.vs.3$p.value)

colnames(rslt) <- c("1.vs.2", "2.vs.3", "1.vs.3")
rslt
```

Los valores obtenidos para el p-valor en todas las comparaciones están por debajo del valor de significación, por lo que las medias son significativamente distintas.


_**Conclusión de Sección**_:
La única variable continua que presenta valores distintos de la media para los distintos niveles del factor _**Contaminación del Aire**_ , es el atributo _**NOx**_. El resto de las variables, no cuenta con suficiente capacidad predictiva para distinguir observaciones que pertenecen a las categorías **Moderada** y/o **Alta**. 


# 6. Modelo Tentativo
En el siguiente segmento se procede a extraer una parte del conjunto de datos para utilizarlo como set de pruebas, durante la evaluación de la precisión de los modelos que sean generados.

```{r Juego de datos para training y test }
#### Formación del set de datos de Entrenamiento y de Test

sample.size <- nrow(cga2018.dat)     # Total de observaciones cargadas
m.training.size <- 0.8               # Porcentaje de la Muestra dedicada a Entrenamiento
set.seed(1965)

### Muestreo aleatorio para extraer el set de Entrenamiento
###
m.training.set <- sample( sample.size, sample.size * m.training.size ) 

# Tomando los valores esperados de la variable de respuesta para el set de prueba
#
m.test.rsl <- cga2018.dat[ -m.training.set, "CA" ]

# Se separa el set de entrenamiento del Arbol
#
m.training.tree <- cga2018.dat[ m.training.set, ]

## Eliminación de atributos redundantes o que han demostrado baja contribución 
## por su escaso poder predictivo, además de la variable objetivo
##
cga2018.dat <- cga2018.dat[ , c( -3, -4, -5, -6, -7, -8, -12)]

# Se separa el set de entrenamiento del kmeans (kproto)
#
m.training <- cga2018.dat[ m.training.set, ]
m.test <- cga2018.dat[ -m.training.set, ]
```

## 6.1 Ensayo: Modelo de Agrupación
Considerando que las variables que tienden a tener mayor fuerza predictiva están disponibles para todos los tipos de vehículos listados en la data original, una primera aproximación interesante es la de considerar un algoritmo de agrupación, que en caso de resultar pudiera incluir en sucesivos experimentos las filas eliminadas a causa de la supresión de la variable _**Tipo de Combustible**_ (excluida del ejercicio por falta de representatividad en la muestra, para resultados de la variable de respuesta).

Un método no supervisado como el **k-means** pudiera ser de utilidad, pero en su versión para datos mixtos (numéricos y categóricos), cuya implementación está disponible a través de la función **kproto**. 

En vista de que hemos rexpresado en 3 niveles al atributo _**CA**_, impondremos k = 3 para la inicialización del hiperparámetro del modelo.

```{r Modelo k-proto para nuestra muestra }
#### kmeans para data mixta: numérica y categórica
##
mv <- kproto(m.training, 3)

#clprofiles(mv, m.training)

m.predicted.clusters <- predict(mv, m.test)
m.pred <- factor(m.predicted.clusters$cluster)

confusionMatrix(m.pred, m.test.rsl)
```

La precisión obtenida es demasiado baja como para promover este modelo, que en parte nos reafirma el caracter poco predictivo de los datos.

## 6.2 Ensayo: Modelo de Clasificación
Alternativamente, consideraremos un modelo de árbol que ayude a ilustrar mejor la realidad de las caracteríticas de nuestro set de datos. Para ello utilizaremos las variables contínuas _**NOx**_ y _**CO2**_, además de las variables categporicas que hemos analizado en apartes anteriores (_**trans**_, _**cil**_ y _**GEI**_):

```{r Modelo arbol CART para nuestra muestra }
#### Modelo de árbol CART 
##
mv <- rpart(CA~NOx+CO2+trans+cil+GEI, data=m.training.tree, method="class")

printcp(mv) # resultados del modelo
plotcp(mv)  # visualización de resultados 
```

El algoritmo considera al atributo _**NOx**_ suficiente para la confección del árbol, cuestión que intuitivamente se anticipaba a partir del estudio de la media, realizado en secciones previas.

El árbol es bastante pequeño, y el nivel de complejidad que minimiza el error es que el corresponde al CP 2, tal como se ve en la tabulación de resultados y gráfica correspondiente.

```{r Modelo arbol CART para nuestra muestra - grafica}
#### Modelo de árbol CART 
##
plot(mv, uniform=TRUE, main="Clasificación de CA")
text(mv, use.n=TRUE, all=TRUE, cex=.7)
```

Como parte del resultado de la construcción del árbol, se obtiene la calificación de importancia que da el algoritmo a los atributos considerados para la confección. La información se extrae de la variable variable.importance, obtenida del objeto summary(), resultante de aplicar la función al modelo.

```{r Obtener la importancia de las variables de la Evaluación del arbol, echo=F, results = 'hide'}
aux.sum <- summary(mv)
```

```{r Exponer la importancia de las variables de la Evaluación del arbol, echo=F}
# Se expone la importancia de las variables de acuerdo al algoritmo de construcción del arbol
#
print(aux.sum$variable.importance)
```

Utilizando el conjunto reservado para el test, y estimando la precisión del modelo:

```{r Evalaución del modelode de arbol, warning=F}
#### Evaluación del MOdelo de árbol CART 
##

##  Obtención de predicción a partir del set de Prueba
###
m.rpart.predict <- predict(object = mv,
                                   newdata = m.test, 
                                   type = "class")
m.pred <- factor(m.rpart.predict)
#
# Matríz de confusión construida con los resultados de la predicción vs
# la clasificación disponible en el set de prueba ...
#
confusionMatrix(m.pred, m.test.rsl)

```

La tasa de precisión que alcanza este nuevo modelo basado en un árbol CART, lo señala como muy adecuado el problema que nos hemos planteado.

## 6.3 Ensayo: Modelo de Regresión Logística
Si consideremos que la proporción de vehículos asociados a la categoría de contaminación del aire **Baja** es realmente muy baja en comparación con las otras dos, puede proponorse su integración a la categoría **Moderada**, de manera de convertir el problema de clasificación que hemos manejado hasta ahora, en uno de tipo binario.

Bajo el cancepto anterior, se desea evaluar la probabilidad de que un vehículo correspondiente a una nueva observación pueda ser clasificado como perteneciente a la categoría **Moderada** o **Alta**, para ello puede utilizarse un modelo regresión logística, estimado con las variables estudiadas hasta ahora. Particularmente, tomaremos como referencia la importancia con la que el algoritmo CART califica a las variables del set.

La variable dependiente será una variable binaria que indicará si el vehículo pertenece a la categoria de Contaminación de Aire **Alta**, o no

```{r reclasificación de categorias}
### Se incorpora variable dicotomica con 1 para vehículos con CA Alta, 0 al resto
###
m.training.tree$high <- ifelse(m.training.tree$CA == 3, 1, 0)
m.training.tree$high <- factor(m.training.tree$high)

m.test.rsl <- ifelse(m.test.rsl == 3, 1, 0)
m.test.rsl <- factor(m.test.rsl)
```

Se estima el modelo a través de una regresión logística, utilizando solo las variables relacionadas con emisiones _**NOx**_ y _**CO2**_, en vista de que las restantes ya han probado su escasa capacidad predictiva:

```{r Estimación del Modelo de Regresión Logistica}
## Estimación del modelo de Regresión Logística para determinar la 
## probabilidad de estar en la categoria CA Alta 
## (solo con atributos de emision NOx y CO2)
#
mv <- glm(high ~ NOx+CO2, m.training.tree, family=binomial())
summary(mv)
```

Tal como ya sabiamos de secciones anteriores, el sumario del modelo nos confirma que si bien el atributo _**NOx**_ es significativo para la regresión, la variable _**CO2**_ no permite rechazar la hiptesis nula, por lo que el parámetro no es significativo para el modelo.

Refactorizando solo con el atributo _**NOx**_  en la ecuación:
```{r Estimación del Modelo de Regresión Logistica - solo NOx}
## Estimación del modelo de Regresión Logística para determinar la 
## probabilidad de estar en la categoria CA Alta 
#
mv <- glm(high ~ NOx, m.training.tree, family=binomial())
summary(mv)
```

El valor del indicador AIC se muestra ligeramente inferior al previamente obtenido, por lo que se trata este último de un mejor modelo.

Para evaluar el modelo, determinaremos la Matriz de confusión, suponiendo un umbral de discriminación del 95%.

```{r Evaluacion del modelo de regresion logistica}

### Predicciones del modelo a partir de la data de entrenamiento
###
m.pred <- predict(mv, newdata = m.training.tree, type = "response")

### Confección de Matriz de Confusión al 95%
### utilizando como referencia la variable binaria "high"" introducida para la 
### estimación del modelo
###
lvs <- c("Alta", "Otras")

highCA   <- factor(m.training.tree$high , labels = rev(lvs))
highCA.p <- factor(as.numeric(m.pred>0.95), labels = rev(lvs))
  
caret::confusionMatrix(highCA.p, highCA, positive = "Alta")
```

El resultado es bastante bueno, con una precisión tan alta como la que muestra el árbol de la sección anterior, siendo el modelo capaz de reconocer todos los vehículos de categorías inferiores (Specificity con valor 1).

# 7. Conclusiones

A lo largo del trabajo se ha tomado un juego de datos público, y se le han aplicado una serie de análisis y técnicas de limpieza y preparación, con el objetivo de construir un modelo analítico que  facilite la clasificación de los casos.

Así, se han identificado y resuelto casos de valores perdidos, y agrupaciones de valores en categoría más altas (con la intención de simplificar la dimensión del problema). Ante la presencia de valores de tipo outliers para las variables de la muestra, se optó por no ajustarlas, por tratarse de especificaciones técnicas que pudieran estar respondiendo a características legítimas de la oferta, justificadas por la alta segmentación que experimenta el mercado automotriz. 

Específicamente, cualquier intento de tratamiento de los casos para los valores reportados en relación a las emisiones (presuntos outliers), solo puede ser procesadas bajo conocimiento funcional del dominio del problema, de modo que las acciones que se puedan adelantar en este sentido, sean coherentes y no desvirtúen la calidad de los datos. No obstante, una breve investigación sobre el tema, nos hacen pensar que los niveles reportados, son correctos y son similares a mediciones practicadas por instituciones como la ADAC.

Esta última observación es particularmente importante, ya que en parte, la normalidad de las variables pudo haber estado alterada por la presencia de tales valores.

Se han evaluado las distintas variables incluidas en el set, y la forma en que se distribuyen en relación a la variable objetivo que se ha definido, para finalmente hacer una selección en base los resultados obtenidos por las pruebas de correlación y el potencial predictivo que les es propio (a través del estudio del comportamiento de las medias por categoría respuesta).

En general, la ausencia de normalidad en las variables continuas de la muestra, así como la presencia de hetereoscedasticidad, nos llevó a utilizar versiones no paramétricas de los test estadísticos. Particularmente, resultó una limitante importante durante el análisis estadístico, en vista de la imposibilidad de utilizar la técnica anova para el estudio de las medias en función a los grupos establecidos por las variables categóricas.

Lamentablemente el set de datos presenta un déficit estructural con respecto a la casuística que debería considerarse dentro del dominio del problema, ya que no se dispone de suficientes valores para uno de los estratos de una de las variables, además de que para algunas categorías de la variable de respuesta se aprecia un desbalance en lo referente a la disponibilidad de casos etiquetados para algunas de las categorías:

    Particualarmente, el modelo de árbol para la calificación del nivel de la Contaminación del 
    Aire que hemos obtenido, para la predicción del nivel de contaminación generado por vehículos 
    a Gasolina, no puede ser aplicado a observaciones correspondientes a modelos que consumen
    Diesel como combustible.

El problema que nos hemos planteado es de tipo Clasificación, tal como se recoge en el resultado obtenido, su comparación con un intento previo de aplicar un método de agrupamiento, nos confirma que otros tipos de modelos pueden resultar inútiles e inaplicables a causa de la escasa precisión que obtienen por la mezcla de tipos de datos que presenta la muestra, y la estructura misma de la información que engloban.

El desarrollo de un último modelo de Regresión Logística ha resultado muy acertivo, pero en un escenario en el que se reducen aún más las categorías de contaminación de Aire. Si bien, no es tan bueno como el de árbol, puede ser utilizado como un modelo alternativo en caso de que se ajuste a las restricciones de uso, pero debe ternerse en cuenta que sigue siendo válida la restricción de uso sobre vehículos a **Diesel**, ya que el modelo no ha sido entrenado con datos pertenecientes a este estrato.